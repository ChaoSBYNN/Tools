# Event-Driven Model 事件驱动领域

> 简介： 事件驱动架构（Event Driven Architecture）是一个流行的分布式异步架构模式，可以用来设计规模很大的应用程序。基于这种架构模式应用可大可小。它由高度解耦的，单一目的的事件处理组件组成，可以异步地接收和处理事件。

- [事件驱动架构离我们还有多远？](https://www.infoq.cn/article/AQUT4uhfR3rJX5oCVxpq)
- [软件架构模式之事件驱动架构](https://developer.aliyun.com/article/947871)

> 近年来，随着云原生、Serverless 等技术关键词都成为了 buzz word，事件驱动再一次成为了云应用架构领域的热门词汇。Gartner 报告将 Event-Driven Model 列为 10 大战略技术趋势之一，事件驱动架构（EDA）将成为未来微服务的主流。该报告同时做出了以下预言：

- 到 2022 年，事件通知的软件模型将成为超过 60% 的新型数字化商业的解决方案；
- 到 2022 年，超过 50% 的商业组织将参与到事件驱动的数字化商业服务的生态系统当中。

## 美好的未来，骨感的现实

然而，抛开美好的畅想，在实际工作中，落地事件驱动架构不是一件简单的事情，其问题主要体现在以下方面：

- *事件无标准，获取困难*：阿里云的云产品，从 IaaS 到 PaaS，每天都有数以亿计的事件产生，但这些云产品没有采用统一的标准和规范来定义描述这些事件，使得用户无法使用同样的方式来获取处理事件。
- *事件孤岛严重，无法串联应用*：云产品的事件天然孤立，因为缺少统一的事件中枢，使得用户做应用处理时很难将多个产品的事件做串联组合，无法形成规模效应，很难挖掘出有用的业务价值。
- *事件响应能力弱*：当前大多数云产品事件的处理场景都停留在事件本身的监控、告警展示层面，属于离线分析的场景，而云上的用户更加需要将这些事件连接到自身的在线业务系统中，实现事件的在线响应处理，以发挥更大的价值。
- *事件管理能力差*：当前大部分云产品的事件管理能力处于初级阶段，缺乏对事件生命周期的全程管理，缺少事件长期归档、查找、轨迹诊断等能力，用户使用过程中定位问题较为困难。

## 事件驱动架构

事件驱动架构（Event Driven Architecture）是一个流行的分布式异步架构模式，可以用来设计规模很大的应用程序。基于这种架构模式应用可大可小。它由高度解耦的，单一目的的事件处理组件组成，可以异步地接收和处理事件。

> 一个事件驱动系统典型地由事件消费者和事件产生者组成，事件消费者向事件管理器订阅事件，事件产生者向事件管理器发布事件。当事件管理器从事件产生者那接收到一个事件时，事件管理把这个事件转送给相应的事件消费者。如果这个事件消费者是不可用的，事件管理者将保留这个事件，一段间隔之后再次转送该事件消费者。

## 关键概念解释

- 事件：系统或组件的状态发生变化时，系统层发出的通知。
- 解耦方式：每个对象都通过与中间件（Mediator or Broker）实现与外界的沟通，而不是相互依赖（迪米特法则）。
- 通讯方式：以消息为载体、通过中间件传递通讯。

## 拓扑结构分类

它包括两个主要的拓扑结构：mediator 和 broker。

- mediator拓扑结构

需要你在一个事件通过mediator时精心安排好几个步骤；

- broker拓扑结构

无需mediator，而是由你串联起几个事件。
这两种拓扑架构的特征和实现有很大的不同，所以你需要知道哪一个适合你。

## Mediator拓扑结构

Mediator拓扑结构适合有多个步骤的事件，需要安排处理层次。
采用Mediator模式的架构中，事件一般是复杂的（包含多个执行单元的合集），而Mediator的责任就是将该复合事件拆解为独立的子事件，然后发送到不同类型的子事件处理系统中，由子系统完成独立子事件的分发和处理。
在结构上，Mediator的EDA架构包括4个组件：

- event queues 用于原始事件（分类）存储，并转发给Event Mediator，一般是以MQ的形式存在。
- event mediator 用于原始事件的拆解（成为多个独立子事件），并转发给相关的Channel；
- event channels 通道（可以理解为细分的Event Queue），按照事件的类型不同作以划分。它可以是一个消息队列，提供给特定的Processor查询，或是消息Topic，发送特定的广播。
- event processors 事件处理器，监听特定的Channel，并在捕获事件后进行处理

Mediator的处理过程如下图所示：

![Mediator](https://ucc.alicdn.com/pic/developer-ecology/b208afe9eb734de2a64c21913223cf20.png)

- 客户端发送一个事件到事件队列(event queues)中，它用来将事件传送给event mediator；
- Event mediator收到初始的事件后，会发送额外的一些异步事件给event channels来执行处理的每个步骤；
- Event channels 既可以是消息队列，也可以是消息topic，大部分是消息topic，这样可以由多个消息处理器(event processor)处理同一个消息。
- Event processors监听event channels,接收事件并处理一些业务逻辑。

*值得注意的是：*
1. 在事件驱动架构中有十几个甚至几百个事件队列都很正常。
2. 模式本身没有限定事件队列的实现方式，它可能是一个消息队列，一个web service或者其它；
3. 消息处理器包含实际的业务逻辑。每个消息处理器都是自包含的，独立的，高度解耦的，执行单一的任务。

## Broker拓扑架构

Broker是一种更简洁的事件驱动架构，不同于上面的结构，它没有中心的Mediator。
在结构上，Broker的EDA架构包括3个组件：

- Event 事件消息；
- Event Channel 消息队列或者是Topic，根据订阅推送（或是转发）消息；消息可能被转发到Event Processor，或是其他的Event Channel中。
- Event Processor 获得消息后执行处理。它可能是一个消息的处理终结点，也可能在处理过程中继续下发消息，或生成新的事件，并被再次提交到Event Channel中，继续下一轮的转发和处理。

![Broker](https://ucc.alicdn.com/pic/developer-ecology/6c47bc02549f4aa98ac1d68d59b5a479.png)

如图所示，它包含两个组件broker和 event processor。

- broker中的event channel可以是消息队列，消息topic或者它们的复合形式。
- 每个event processor负责处理事件，发布新的事件。

## 架构考量

事件驱动架构模式实现起来相对复杂，主要是由于它的异步和分布式特性。这可能会带来一些分布式的问题，比如远程处理的可用性，缺乏响应，broker重连等问题。
1. 分布式的异步架构
  事件处理器之间高度解耦，软件的扩展性好，事件处理器可以独立地加载和卸载，容易部署，同时性能较好，因为事件的异步本质，软件不易产生堵塞。
2. 对于单一的逻辑缺乏原子事务
  此模式需要将原子事务交给一个事件处理器执行，跨事件处理器的原子事务是很困难的，很难进行回滚操作。同时对于事件处理器的创建，维护和管理比较困难，事件通常有特殊的约定（数据值和格式）。

## 模式分析

结合上文分析，事件驱动架构设计模式整体分析如下：

- 总体灵活性： 高
- 发布易用性： 高
- 可测试性： 低
- 性能： 高
- 规模扩展性： 高
- 开发容易度： 低

## EventBridge 事件总线基本模型

为了解决这些现实问题，2020 年 11 月，阿里云发布了 EventBridge 事件总线。作为一款无服务器事件总线服务，EventBridge 作为云事件的枢纽，以标准化的 CloudEvents 1.0 协议连接云产品和云应用，提供中心化的事件治理和驱动能力，帮助用户轻松构建松耦合、分布式的事件驱动架构。
另外，在阿里云之外的云市场上有海量垂直领域的 SaaS 服务，EventBridge 将以跨产品、跨组织以及跨云的集成与被集成能力，助力客户打造一个完整的、事件驱动的、高效可控的上云新界面，阿里云 EventBridge 可以提供以下核心能力：

（1）海量阿里云官方事件源：EventBridge 当前支持了阿里云 60+云产品的官方事件接入，用户零成本即可获取各类资源、运维和审计事件。
（2）多类型自定义事件源：EventBridge 支持用户以 CloudEvent1.0 标准协议上传自定义的事件内容，同时还支持消息、数据库变更等类型的数据源清洗成自定义事件。
（3）丰富的事件目标和处理模式：EventBridge 支持短信、邮箱、钉钉、API 等 10+事件目标，并支持全量部分提取、常量、模板等 10+事件处理模式，用户无需任何代码即可完成事件驱动和处理。
（4）完善的事件管理和触达能力：EventBridge 支持事件生命周期查询、轨迹追踪等诊断能力，支持跨网络、跨账号、跨地域的复杂事件触达能力。

EventBridge 产品包含几个基本概念：事件、事件总线、事件源、事件规则以及事件目标。

![EventBridge](https://static001.geekbang.org/infoq/61/6100557f2543c20dbcaa5766930e7e2e.png)

如上图所示，事件由阿里云官方、自定义、第三方 SaaS 这三类事件源产生并传输到事件总线，用户在事件总线内配置事件规则以实现事件过滤、转换处理，并最终投递到用户指定的事件目标。

## 典型场景

根据 EventBridge 当前已经具备的能力，给大家介绍下三个典型的案例：

### 场景 1：云原生海量媒体处理业务

在线教育、游戏直播行业，伴随着在线课堂、直播间的产生，会有大量的媒体数据，例如视频、音频文件需要做剪辑、切分、转码等复杂处理。这类业务处理量往往存在较为陡峭的波峰波谷，业务上需要实时的事件驱动协调以及 Serverless 化的执行处理能力，以满足高实时、低成本、极致弹性的业务需求。

~[bg1](https://static001.geekbang.org/infoq/59/59249c7c01fb620f6de634571416b6ac.png)

在这个业务场景中，EventBridge 收集来自原始文件的上传、变更事件，并根据业务逻辑驱动下游的函数计算做高并发、可弹性的媒体处理逻辑，在函数计算产品处理完成后将结果驱动下游的媒体通道，同时处理结果可以通过 EventBridge 触达到钉钉、短信邮箱等离线通知渠道以及 API、消息队列等在线渠道。使用 EventBridge+函数计算的方案弹性扩容能开强，运维成本更低、实时性更强。

### 场景 2：360 度业务全景

随着企业业务规模的扩大，业务的稳定性愈发重要，为了避免故障随着场景的复杂化而频繁发生，对应用建设 360  度全方位的可观测和监控体系尤为重要。传统的应用基于云原生重构后，享受云原生技术红利的同时也为应用的稳定性治理带来了更多的复杂性，最主要的就是变更难以控制：业务依赖了整套云的基础设施，IaaS 层物理资源、网络资源以及 PaaS 层云服务，甚至依赖的上下游服务，时刻都在进行变更，用户很难立马感知到变更的发生以及相应的影响，而 95% 的故障都是由变更导致的。

为了解决这个问题，通过 EventBridge 打造 360 度业务全景图，清晰地感知整个产品业务链路上，做了哪些变更，有哪些异常反应，这些异常反应是不是跟最近的变更有关联，遇到特殊问题时，我们甚至可以通过自运维的方式，帮助产品更快的恢复，将影响面降低到最小。

![bg2](https://static001.geekbang.org/infoq/8f/8f53e1699a04d86d29bfa46b99fb4421.png)

而这些能力的拥有，离不开 EventBridge 集成多个云产品事件的能力，也离不开 EventBridge 可以通过事件触发多个云产品响应的能力。事件作为一个信息的重要载体，通过 EventBridge 优雅的协调各个云产品进行有序工作。

### 场景 3：新零售智慧家具门店

EventBridge 未来可以触达的场景有多大？让我们看一个新零售智慧家具门店的场景：

- 仓库的家具商品入库事件、门店的顾客进店事件通过 EventBridge 实时流转到在线分析系统，让我们知道现在店内有哪些家具商品，进店顾客的家具偏好是什么，并推送给商场门店的导购员或则广告屏，帮助门店更好的下单转化；
- 顾客在线电子支付后，订单信息发送到 EventBridge，并触发第三方物流公司进行送货上门；
- 第三方物流公司，可以实时的将家具的位置信息通过 EventBridge 推送给移动端 APP，客户可以通过 APP 很方便的实时了解到自己的家具到哪了，预估还需要多久送到家；

所有这些通过 EventBridge 流转的在线业务事件数据，最终通过 EventBridge 流转到离线分析系统，自动生成业务报表，供管理层做绩效考核或则运营决策。

![bg3](https://static001.geekbang.org/infoq/d0/d01ae006ad3d754d5e5620f7fe6a4658.png)

在这个场景中，EventBridge 起着关键的通道作用，无论是 IoT、在线业务、还是大数据场景，EventBridge 将事件信息高效的流转，推动业务目标达成。Event 既作为在线业务数据，又作为离线分析数据，这种方式，既降低了成本，同时也提高了效率。





