# DDD Domain Driven Design 领域驱动设计

领域驱动设计(DDD)主张技术方与业务方通过贴近业务的统一语言来沟通，关联领域模型与软件实现相比领域模型本身的好坏更为重要。命名恰当的话，业务人员甚至可以“读”懂代码，技术人员能够在代码中理解业务。那我们的领域模型该如何落地呢？分离领域对于能否成功运用领域建模起着关键作用。根据软件行业的惯例，软件系统普遍采用分层架构(Layered architecture)给复杂的应用程序划分层次，将所有与领域模型相关的代码可以放到领域层，关注于领域逻辑。领域层的领域模型可以捕捉并有效地使用业务知识。本文将从分层架构的本质，DDD 分层架构，六边形架构，洋葱架构，整洁架构和微服务时代的分层架构来进行刨析。

## 分层架构的本质

分层的本质是关注点分离，隔离对下层的变化。由于层间松散的耦合关系，使得我们可以专注于本层的设计，而不必关心其他层的设计，也不必担心当前层的设计会影响其它层。无需过多的了解其他层次，只需要关注本层的知识，有利于标准化工作，如消费者只需要知道 API 层的接口，无需了解这个 API 是具体业务和领域逻辑的实现；方便替换每一层的具体实现，甚至硬件层面的替换；一旦建立好了某一层次，就可以用其为上一层提供服务，如中台服务。

当然分层也有一些缺陷：层次不能分装所有的东西，有时候会有级联修改，如需要在 API 中增加一个参数，那么就需要修改每一个层次的方法引起级联修改的问题；过多的层次会影响性能和开发效率。

更多的分层等于更高的复杂度，开发人员需要的认知越多，但是对问题的发现和定位越准确；更少的分层等于更低的复杂度，开发人员需要的认知越容易，但是对问题的发现和定位越困难，一旦出错，在某一层次的错误会较多，修改较难。

## DDD分层架构

> 2004年Eric Evans 发表Domain-Driven Design –Tackling Complexity in the Heart of Software （领域驱动设计），简称Evans DDD。领域驱动设计分为两个阶段：

![DDD](https://pic1.zhimg.com/80/v2-c6deea16ebf0ccc00f2f6bfbd0da4430_720w.webp)

![DDD2](https://pic4.zhimg.com/80/v2-471a850a6dfcbfda0689fd5731c49fc3_720w.webp)

### 识别核心限界上下文边界

识别核心域，然后寻找与核心域有关的概念，将这些概念放入核心限界上下文中；与核心域无关的概念，就放在核心限界上下文之外。

- 首先限界上下文「是语义和语境上的边界」
- 核心域的概念：「当限界上下文被当作组织的关键战略举措进行开发时，即被称之为核心域」。这里没有明说核心域和限界上下文的关系，但是我们至少可以得知：核心域对应于某个限界上下文。
- 通用语言「在限界上下文中……用于表达其边界内的软件模型」

寻找与核心域有关的概念，这些概念都需要符合核心限界上下文内的通用语言，该通用语言表达的模型就是核心限界上下文边界内的模型，这些模型也就属于这个限界上下文。而与核心域无关的概念，就在核心限界上下文之外。


## 六边形架构

> 六边形架构是Alistair Cockburn在2005年在其博客中提出的，是在2003年Eric Evans提出DDD之后。实际上六边形架构也是一种分层架构，把DDD分层架构的上下关系说成了内部和外部的关系。六边形架构又称为端口-适配器架构，将系统分为内部（内部六边形）和外部，内部Application代表了自身应用的业务逻辑，外部代表应用的驱动逻辑、基础设施或其他应用。适配器分为两种类型，上侧代表 Web 和 Message Handler 的适配器被称为主动适配器（Driving Adapters），因为是它们发起了对应用的一些操作。而下侧表示和后端工具链接的适配器，被称为被动适配器（Driven Adapters），因为它们只会对主适配器的操作作出响应。

![six](https://pic3.zhimg.com/80/v2-d0e5405b898cb551d7a02a4f6b35e08a_720w.webp)

## 洋葱架构

> 洋葱架构是 Jeffrey Palermo 在2008年提出的，与六边形架构有着类似的思路，都通过编写适配器(User Interface, Infrastructure)代码将应用核心从对基础设施和用户接口的关注中释放出来，避免基础设施和用户接口的代码渗透到应用核心(Application, Application Core)之中。这样应用系统使用的工具和消息传达机制能容易替换，在一定程度地避免技术、工具或者供应商的限制。
> 洋葱架构还告诉我们，企业应用中存在着不止系统内部的应用层和外部的端口适配器层，它在 Application Core 中引入了一些在领域驱动设计中的层次(Application，Domain Service，Domain model等)。另外，它可以脱离实际基础设施和传达机制，使用 mock 代替基础设施和传达机制，让 Application 可以方便测试。

![Onion](https://pic1.zhimg.com/80/v2-519dd9ff822e3603aacbc31308cf103c_720w.webp)

## 整洁架构

> 整洁架构是 Uncle Bob 在2017年提出的，与洋葱架构和六边形架构有着类似的思路。下图是整洁架构示意图，其中的 Entities 与洋葱架构中的 Domain Model 相对应，User Cases 与洋葱架构的 Domain Services 相对应，Controllers、Presenters和Gateways与洋葱架构的Application services相对应，最外层的Web, UI, DB等与洋葱架构的最外层相对应。

![Clean](https://pic2.zhimg.com/80/v2-4e507e3509671f8c1c7333b197e803cd_720w.webp)
