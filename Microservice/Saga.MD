# Saga

如果微服务使用独享数据库，那么通过分布式事务管理一致性是一个巨大的挑战。你无法使用传统的两阶段提交协议，因为它要么不可伸缩（关系数据库），要么不被支持（多数非关系数据库）。

但您还是可以在微服务架构中使用 Saga 模式实现分布式事务。Saga 是 1987 年开发的一种古老模式，是关系数据库中关于大事务的一个替代概念。但这种模式的一种现代变种对分布式事务也非常有效。Saga 模式是一个本地事务序列，其每个事务在一个单独的微服务内更新数据存储并发布一个事件或消息。Saga 中的首个事务是由外部请求（事件或动作）初始化的，一旦本地事务完成（数据已保存在数据存储且消息或事件已发布），那么发布的消息或事件则会触发 Saga 中的下一个本地事务。

![Saga](https://pic1.zhimg.com/80/v2-9d7d633aeb10cd53d5ecbe2d980c1f35_720w.webp?source=1940ef5c)

如果本地事务失败，Saga 将执行一系列补偿事务来回滚前面本地事务的更改。

Saga 事务协调管理主要有两种形式：

- 事件编排 Choreography：分散协调，每个微服务生产并监听其他微服务的事件或消息然后决定是否执行某个动作。
- 命令编排 Orchestration：集中协调，由一个协调器告诉参与的微服务哪个本地事务需要执行。

优点

- 为高可伸缩或松耦合的、事件驱动的微服务架构提供一致性事务。
- 为使用了不支持 2PC 的非关系数据库的微服务架构提供一致性事务。

缺点

- 需要处理瞬时故障，并且提供等幂性。
- 难以调试，而且复杂性随着微服务数量增加而增加。

何时使用 Saga

- 在使用了事件源的高可伸缩、松耦合的微服务中。
- 在使用了分布式非关系数据库的系统中。

何时不宜使用 Saga

- 使用关系数据库的低可伸缩性事务型系统。
- 在服务间存在循环依赖的系统中。

可用技术示例

Axon， Eventuate， Narayana

延伸阅读

- Saga分布式事务-Azure设计模式https://docs.microsoft.com/en-us/azure/architecture/reference-architectures/saga/saga
- 微服务模式：Sagashttps://microservices.io/patterns/data/saga.html
- Saga 模式：微服务中的应用程序事务https://blog.couchbase.com/saga
