# Onion Architecture 洋葱架构

领域是一个知识的范畴。它指的是我们的软件所要模拟的业务知识。领域驱动设计的中心是领域模型，它对一个领域的流程和规则有着深刻的理解。洋葱架构实现了这一概念，并极大地改善了代码的品质，降低了复杂性，并且支持不断发展的企业系统。

> 基于六边形架构的原则，洋葱架构在核心/域和基础设施之间建立了明确的分离。 层围绕着核心，内层表示抽象的业务关注点，外层处理技术细节和框架。

![Onion](https://pic1.zhimg.com/80/v2-eb79571564394a44c62f2d51c058b3ac_720w.webp)

## Why 为什么要用洋葱架构？

> 领域实体是核心和中心部分。洋葱架构是建立在一个领域模型上的，其中各层是通过接口连接的。其背后的思想是，在领域实体和业务规则构成架构的核心部分时，尽可能将外部依赖性保持在外。

- 它提供了灵活、可持续和可移植的架构。
- 各层之间没有紧密的耦合，并且有关注点的分离。
- 由于所有的代码都依赖于更深的层或者中心，所以提供了更好的可维护性。
- 提高了整体代码的可测试性，因为单元测试可以为单独的层创建，而不会影响到其他的模块。
- 框架/技术可以很容易地改变而不影响核心领域。例如，RabbitMQ 可以被 ActiveMQ 取代，SQL 可以被 MongoDB 取代。

## How 原则

洋葱架构是由多个同心层构成，它们相互连接，并朝向代表领域的核心。它是基于控制反转（Inversion of Control，IoC）的原则。该架构并不关注底层技术或框架，而是关注实际的领域模型。它是基于以下原则：

### 依赖性

圆圈代表不同的责任层。一般来说，我们潜入得越深，就越接近于领域和业务规则。外圈代表机制，内圈代表核心领域逻辑。外层依赖于内层，而内层则对外圈一无所知。通常情况下，属于外圈的类、方法、变量和源代码依赖于内圈，但是反过来也一样。

数据格式/结构可能因层而异。外层的数据格式不应该被内层使用。例如，API 中使用的数据格式可以与 DB 中用于持久化的数据格式不同。数据流可以使用数据传输对象。每当数据跨层/跨界时，它应该以方便该层的形式出现。例如，API 可以有 DTO，DB 层可以有 Entity Objects，这取决于存储在数据库中的对象与领域模型的不同。

### 数据封装

每个层/圈封装或隐藏内部的实现细节，并向外层公开接口。所有的层也需要提供便于内层消费的信息。其目的是 最小化层与层之间的耦合，最大化跨层垂直切面内的耦合 。我们在较深的层定义抽象接口，并在最外层提供其具体实现。这样可以确保我们专注于领域模型，而不必过多地担心实现细节。我们还可以使用依赖性注入框架，比如 Spring，在运行时将接口与实现连接起来。例如，领域中使用的存储库和应用服务中使用的外部服务在基础设施层实现。

![package](https://pic1.zhimg.com/80/v2-1ab0b286937c59e700f55f626211645c_720w.webp)

### 关注点的分离

应用被分为若干层，每一层都有一组职责，并解决不同的关注点。每一层都作为应用中的模块/包/命名空间。

### 耦合性

低耦合性，可以使一个模块与另一个模块交互，而不需要关注另一个模块的内部。所有的内部层都不需要关注外部层的内部实现。



